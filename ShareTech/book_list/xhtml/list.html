<!DOCTYPE html>
<html>
<head>
<?php require("xhtml/script_css.html") ?>
<script type="text/javascript" src="js/FileSaver.min.js"></script>
<script type="text/javascript" src="js/jquery-1.11.3.min.js"></script>
<script type="text/javascript" src="js/jquery-1.12.1.ui.js"></script>
<script type="text/javascript">
var curPage = 1; //目前頁碼
var total,pageSize,totalPage;

$(function() 
{
    $( document ).tooltip(
    {
        content: function() 
		{
            return $(this).attr('title');
        }
    });
});

$(document).ready(function load_list()
{
	getData(1);
	$(document).on('click', '#pagecount span a', function()
	{
		var rel = $(this).attr("rel");
		if (rel) {
			getData(rel);
		}
	});
	
	$('#sort').change(function ()
    {
		var rel = curPage;
		getData(rel);
	});
	
	$('#output').click(function () 
	{
		var string = document.getElementById('list').innerText;
		string  = string.slice(52);
		string  = string.replace(/EDIT/g, "");
		string  = string.replace(/DEL/g, "");
		
		var str = string.split("	");
		var str2 = "";
		var count = 5;
		for (var i in str) {
			str[i]	= str[i].trim();
			if (i == count) {
				count = count + 6;
				str2 += str[i] + "\n";
			} else {
				str2 += str[i] + ",";
			}
		}
		str2  = str2.slice(0, -2);
		
		var blob   = new Blob(["\ufeff", str2], {
			type: "text/plain;charset=utf-8"
		});
		var Today   = new Date();
		var strFile = Today.getFullYear() + "-" + (Today.getMonth()+1) + "-"
					+ Today.getDate() + ".csv";
		saveAs(blob, strFile);
		return false;
	});
});

function getData(page)
{ 
	$.ajax({
		type: 'POST',
		url: 'data.php',
		data: {
			pageNum : page-1,
			sort	: $("#sort").find(":selected").val()
		},
		dataType:'json',
		success:function(json)
		{
			$("#list").empty();
			total      = json.total; //資料總數
			pageSize   = json.pageSize; //每頁數
			curPage    = page; //目前頁數
			totalPage  = json.totalPage; //總頁數
			var li     = "<table><tr><th><input type='checkbox' name='all' onClick='check_all(this, " + '"choose"' + ")'>全選</th>"+
					"<th>ISBN</th><th>出版社</th><th>書名</th><th>作者</th><th>定價</th><th>發行日</th><th>編輯/刪除</th></tr>";
			var list   = json.list;
			$.each(list,function(index,array)
			{
				li += "<tr onmouseover='this.style.backgroundColor=" + '"#EEEEEE"' +
						";' onMouseOut='this.style.backgroundColor=" + '"white"'   +
						";'><td><input type='checkbox' name='choose' value=''></td><td>" +
					array['ISBN']  + "</td><td title='04-27050888 <br /> 台中市西屯區123號'>"+
					array['press'] +"</td><td>" +
					array['bName'] +"</td><td>" +
					array['author']+"</td><td>" +
					array['prize'] +"</td><td>" +
					array['day']   +"</td><td>" +
					"<button style='background-color:#FF9900;'><a href='edit.php?id="   + array['id'] +
					"'> 編輯 </a></button>&nbsp" +
					"<button style='background-color:#FF0000;'><a href='delete.php?id=" + array['id'] +
					"' onClick='return check_delete();'> 刪除 </a></button></tr>";
			});
			li += "</table>";
			$("#list").append(li);
		},

		complete:function() //分頁
		{
			if (total > 16) {
				getPageBar();
			}
		},

		error:function()
		{
			alert("載入失敗!");
		}
	});
}

function getPageBar()
{
	//頁碼大於最大頁
	if (curPage > totalPage) {
		curPage = totalPage;
	}
	//頁碼小於1
	if (curPage < 1) {
		curPage = 1;
	}
	pageStr = "";
	//如果是首頁
	if (curPage == 1) {
		pageStr += "";
	} else {
		pageStr += "<span><a href='javascript:void(0)' rel='1'> |<  </a></span>" +
				   "<span><a href='javascript:void(0)' rel='" + (curPage-1) + "'> << </a></span>";
	}
	
	pageStr += "<span>第 "+curPage+" 頁</span>";
	
	//如果是最後頁
	if (curPage >= totalPage) {
		pageStr += "";
	} else {
		pageStr += "<span><a href='javascript:void(0)' rel='" + (parseInt(curPage)+1) + "'> >> </a></span>" +
				   "<span title='第 " + totalPage + " 頁'><a href='javascript:void(0)' rel='" + totalPage + "'> >| </a></span>";
	}

	$("#pagecount").html(pageStr);
}

function check_all(obj, check)
{
	var checkboxs = document.getElementsByName(check);
	for (var i = 0; i < checkboxs.length; i++) {
		checkboxs[i].checked = obj.checked;
	}
}

function check_delete()
{
	if (confirm("Sure Delete?") == true) {
		return true;
	} else {
		return false;
	}
}

</script>
</head>
<body onload="load_list()">
    <br><br><br>
    <div style="text-align:right;">
		<strong style="color:#003399; font-size:13px;">
			匯出方式
		</strong>
		<select id="output_choose">
            <option value="" selected>請選擇</option>
            <option value="1">匯出全部</option>
			<option value="2">匯出本頁</option>
            <option value="3">匯出選取項目</option>
        </select>
		<input id="output" type="image" src="image/export.png">
	</div>
	<br>
    <div id="choose">
		<strong style="color:#003399; font-size:13px;">
			排序方式
		</strong>
        <select id="sort">
			<option value="1" selected>請選擇</option>
			<option value="ISBN:0">ISBN:ASC</option>
			<option value="ISBN:1">ISBN:DESC</option>
            <option value="press:0">出版社:ASC</option>
            <option value="press:1">出版社:DESC</option>
            <option value="bName:0">書名:ASC</option>
			<option value="bName:1">書名:DESC</option>
            <option value="author:0">作者:ASC</option>
			<option value="author:1">作者:DESC</option>
            <option value="prize:0">定價:ASC</option>
			<option value="prize:1">定價:DESC</option>
            <option value="day:0">發行日:ASC</option>
			<option value="day:1">發行日:DESC</option>
        </select>
		<div id="pagecount"></div>
		<div id="jump_page">
			頁碼:
			<input id="page" type="text">
			<input id="go_page" type="image" src="image/go.jpg">
		</div>
   	</div>
    <div id="list"></div>
    <br>
    <div style="text-align:center;">
        <button style="background-color:#66FF99;">
            <a href="add_list.php">新增</a>
        </button>
    </div>
</body>
</html>
